# Database Schema for Reddit Opportunity Engine

This document outlines the database schema for storing user data, search history, and subreddit recommendations when integrating the Reddit Opportunity Engine with a SaaS template using Supabase and Drizzle ORM.

## Core Tables

### users
*Note: This table is typically handled by Clerk, but we reference it in our schema*

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key, generated by Clerk |
| email | text | User's email address |
| created_at | timestamp | When the user was created |

### searches
*Stores individual search sessions*

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | Foreign key to users table |
| product_type | text | Type of product the user searched for |
| problem_area | text | Problem area the user specified |
| target_audience | text | Target audience the user specified |
| additional_context | text | Additional context the user provided |
| created_at | timestamp | When the search was performed |
| completed_at | timestamp | When the search completed |
| search_time_seconds | float | How long the search took to complete |
| iterations | integer | Number of search iterations performed |
| status | text | Status of the search (completed, failed, etc.) |

### subreddit_recommendations
*Stores individual subreddit recommendations from searches*

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| search_id | uuid | Foreign key to searches table |
| subreddit_name | text | Name of the subreddit (e.g., r/indiehackers) |
| subscriber_count | text | Approximate subscriber count |
| relevance_explanation | text | Why this subreddit is relevant |
| content_type | text | Types of content in this subreddit |
| audience_alignment | text | How the audience aligns with target |
| quality_score | float | Internal quality score (0-10) |
| niche_score | float | How niche/specific the community is (0-10) |
| created_at | timestamp | When the recommendation was created |

### search_terms
*Stores suggested search terms for subreddits*

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| search_id | uuid | Foreign key to searches table |
| term | text | The search term |
| created_at | timestamp | When the term was created |

### saved_collections
*For users to save and organize groups of subreddits*

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | Foreign key to users table |
| name | text | Name of the collection |
| description | text | User description of the collection |
| created_at | timestamp | When the collection was created |
| updated_at | timestamp | When the collection was last updated |

### collection_subreddits
*Junction table for saved_collections and subreddits*

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| collection_id | uuid | Foreign key to saved_collections |
| subreddit_name | text | Name of the subreddit |
| notes | text | User notes about this subreddit |
| created_at | timestamp | When the subreddit was added to collection |

### payments
*Stores payment information*

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | Foreign key to users table |
| stripe_payment_id | text | Stripe payment ID |
| amount | integer | Payment amount in cents |
| currency | text | Payment currency |
| status | text | Payment status |
| product_id | text | Product identifier |
| created_at | timestamp | When the payment was created |

### usage_credits
*Tracks remaining usage credits for users*

| Column | Type | Description |
|--------|------|-------------|
| id | uuid | Primary key |
| user_id | uuid | Foreign key to users table |
| total_credits | integer | Total credits purchased |
| remaining_credits | integer | Remaining credits |
| updated_at | timestamp | When credits were last updated |

## Drizzle ORM Schema Definition

```typescript
import { 
  pgTable, 
  uuid, 
  text, 
  timestamp, 
  integer, 
  foreignKey, 
  real 
} from 'drizzle-orm/pg-core';
import { createInsertSchema, createSelectSchema } from 'drizzle-zod';

// Searches table
export const searches = pgTable('searches', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull(),
  productType: text('product_type').notNull(),
  problemArea: text('problem_area').notNull(),
  targetAudience: text('target_audience').notNull(),
  additionalContext: text('additional_context'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  completedAt: timestamp('completed_at'),
  searchTimeSeconds: real('search_time_seconds'),
  iterations: integer('iterations'),
  status: text('status').notNull().default('pending')
});

// Subreddit recommendations table
export const subredditRecommendations = pgTable('subreddit_recommendations', {
  id: uuid('id').primaryKey().defaultRandom(),
  searchId: uuid('search_id').notNull().references(() => searches.id, { onDelete: 'cascade' }),
  subredditName: text('subreddit_name').notNull(),
  subscriberCount: text('subscriber_count'),
  relevanceExplanation: text('relevance_explanation').notNull(),
  contentType: text('content_type').notNull(),
  audienceAlignment: text('audience_alignment').notNull(),
  qualityScore: real('quality_score').notNull(),
  nicheScore: real('niche_score').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull()
});

// Search terms table
export const searchTerms = pgTable('search_terms', {
  id: uuid('id').primaryKey().defaultRandom(),
  searchId: uuid('search_id').notNull().references(() => searches.id, { onDelete: 'cascade' }),
  term: text('term').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull()
});

// Saved collections table
export const savedCollections = pgTable('saved_collections', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull(),
  name: text('name').notNull(),
  description: text('description'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
});

// Collection subreddits junction table
export const collectionSubreddits = pgTable('collection_subreddits', {
  id: uuid('id').primaryKey().defaultRandom(),
  collectionId: uuid('collection_id').notNull().references(() => savedCollections.id, { onDelete: 'cascade' }),
  subredditName: text('subreddit_name').notNull(),
  notes: text('notes'),
  createdAt: timestamp('created_at').defaultNow().notNull()
});

// Payments table
export const payments = pgTable('payments', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull(),
  stripePaymentId: text('stripe_payment_id').notNull(),
  amount: integer('amount').notNull(),
  currency: text('currency').notNull().default('usd'),
  status: text('status').notNull(),
  productId: text('product_id').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull()
});

// Usage credits table
export const usageCredits = pgTable('usage_credits', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().unique(),
  totalCredits: integer('total_credits').notNull().default(0),
  remainingCredits: integer('remaining_credits').notNull().default(0),
  updatedAt: timestamp('updated_at').defaultNow().notNull()
});

// Zod schemas for validation
export const insertSearchSchema = createInsertSchema(searches);
export const selectSearchSchema = createSelectSchema(searches);
export const insertSubredditRecommendationSchema = createInsertSchema(subredditRecommendations);
export const insertSearchTermSchema = createInsertSchema(searchTerms);
```

## Database Relationships

```
                                                ┌───────────────────┐
                                                │                   │
                                                │      users        │
                                                │                   │
                                                └─────────┬─────────┘
                                                          │
                        ┌────────────────────────────────┬┴─────────────────┬─────────────────────────┐
                        │                                │                   │                         │
                        ▼                                ▼                   ▼                         ▼
              ┌──────────────────┐              ┌────────────────┐  ┌───────────────────┐   ┌──────────────────┐
              │                  │              │                │  │                   │   │                  │
              │     searches     │              │ saved_collections│  │     payments      │   │   usage_credits  │
              │                  │              │                │  │                   │   │                  │
              └────────┬─────────┘              └────────┬───────┘  └───────────────────┘   └──────────────────┘
                       │                                 │
            ┌──────────┴───────────┐                    │
            │                      │                    │
            ▼                      ▼                    ▼
┌────────────────────┐  ┌───────────────────┐  ┌───────────────────┐
│                    │  │                   │  │                   │
│ subreddit_         │  │   search_terms    │  │  collection_      │
│ recommendations    │  │                   │  │  subreddits       │
│                    │  │                   │  │                   │
└────────────────────┘  └───────────────────┘  └───────────────────┘
```

## Migration Strategy

1. Create a Supabase migration to create these tables
2. Set up row-level security policies to ensure users can only access their own data
3. Configure indexes for performance optimization:
   - Create indexes on `user_id` columns
   - Create indexes on `search_id` columns
   - Consider composite indexes for frequently queried combinations

## Data Flow

1. User initiates a search → creates record in `searches` table
2. Agent completes search → updates `searches` record and creates entries in `subreddit_recommendations` and `search_terms`
3. User saves collection → creates record in `saved_collections` and associated `collection_subreddits`
4. User makes payment → creates record in `payments` and updates `usage_credits`

## Backup and Recovery

1. Leverage Supabase's built-in backup mechanisms
2. Implement a scheduled backup procedure for additional security
3. Set up monitoring for database size and performance 